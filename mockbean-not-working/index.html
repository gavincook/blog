<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="gavincook,gavincook200@gmail.com"><title>MockBean"ç½¢å·¥äº†" Â· å®ˆæœ›å†°é›¨</title><meta name="description" content="0. å°çº¢çš„æµ‹è¯•æŒ‚äº†ä½œä¸ºèµ„æ·±æ¬ç –å¤§å¸ˆï¼Œå°çº¢çš„å‡ºæ‰‹çš„å„ç§ä»£ç ï¼Œéƒ½ä¼šæœ‰å¯¹åº”çš„æµ‹è¯•è¿›è¡ŒéªŒè¯ã€‚ä½†ä»Šå¤©å°çº¢å´çŠ¯äº†æ„ã€‚åŸæ¥å°çº¢æœ‰ä¸¤ä¸ªæµ‹è¯•ï¼Œå•ç‹¬è·‘æµ‹è¯•çš„æ—¶å€™éƒ½æ˜¯è‰åŸç»¿ï¼Œä½†ä¸€èµ·è·‘çš„æ—¶å€™æŒ‚æ‰äº†ã€‚
1. æ¡ˆå‘ç°åœºå°çº¢åœ¨è´Ÿè´£çš„å­¦ç”Ÿç®¡ç†ç³»ç»Ÿé‡Œï¼Œæœ‰è¿™ä¹ˆä¸¤ä¸ªéœ€æ±‚ï¼š

æ ¹æ®åå­—æœç´¢å¯¹åº”çš„å­¦ç”Ÿ
ç‚¹å‡»æœç´¢å‡ºæ¥çš„å­¦ç”Ÿä¿¡æ¯ï¼Œèƒ½æŸ¥é˜…å¯¹åº”çš„"><meta name="keywords" content="mockBean,restAssured,not working,springBoot,test"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/prism.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/avatar.png" style="width:127px;"><h3 title><a href="/">å®ˆæœ›å†°é›¨</a></h3><div class="description"><p>åƒé‡Œä¹‹è¡Œå§‹äºè¶³ä¸‹.</p></div></div></div><ul class="social-links"></ul><div class="tags"><a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/io/" style="font-size: 10px;">io</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jdkå·¥å…·/" style="font-size: 17.5px;">jdkå·¥å…·</a> <a href="/tags/jvm/" style="font-size: 17.5px;">jvm</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/netty/" style="font-size: 10px;">netty</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/schedule/" style="font-size: 12.5px;">schedule</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a></div><span id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv">0</span><span>æ¬¡</span></span><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ddd68578fd30a6ed4096f17e5c1fdc57";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><!--script.
  var jiathis_config = {data_track_clickback:'true'};
  script(src="http://v3.jiathis.com/code/jiathis_r.js?type=left&amp;move=0&amp;uid=2128729")
  
script.
  script(async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js")--></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">é¦–é¡µ</a></li><li><a href="/archives/">å½’æ¡£</a></li><li><a href="/about-me/">å…³äº</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="http://gavincook.me/avatar.png"></div></div></div><span id="busuanzi_container_page_pv">é˜…è¯»ï¼š<span id="busuanzi_value_page_pv">0</span><span>æ¬¡</span></span><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>MockBean&quot;ç½¢å·¥äº†&quot;</a></h3></div><div class="post-content"><h3 id="0-å°çº¢çš„æµ‹è¯•æŒ‚äº†"><a href="#0-å°çº¢çš„æµ‹è¯•æŒ‚äº†" class="headerlink" title="0. å°çº¢çš„æµ‹è¯•æŒ‚äº†"></a>0. å°çº¢çš„æµ‹è¯•æŒ‚äº†</h3><p>ä½œä¸ºèµ„æ·±æ¬ç –å¤§å¸ˆï¼Œå°çº¢çš„å‡ºæ‰‹çš„å„ç§ä»£ç ï¼Œéƒ½ä¼šæœ‰å¯¹åº”çš„æµ‹è¯•è¿›è¡ŒéªŒè¯ã€‚ä½†ä»Šå¤©å°çº¢å´çŠ¯äº†æ„ã€‚<br>åŸæ¥å°çº¢æœ‰ä¸¤ä¸ªæµ‹è¯•ï¼Œå•ç‹¬è·‘æµ‹è¯•çš„æ—¶å€™éƒ½æ˜¯è‰åŸç»¿ï¼Œä½†ä¸€èµ·è·‘çš„æ—¶å€™æŒ‚æ‰äº†ã€‚</p>
<h3 id="1-æ¡ˆå‘ç°åœº"><a href="#1-æ¡ˆå‘ç°åœº" class="headerlink" title="1. æ¡ˆå‘ç°åœº"></a>1. æ¡ˆå‘ç°åœº</h3><p>å°çº¢åœ¨è´Ÿè´£çš„å­¦ç”Ÿç®¡ç†ç³»ç»Ÿé‡Œï¼Œæœ‰è¿™ä¹ˆä¸¤ä¸ªéœ€æ±‚ï¼š</p>
<ol>
<li>æ ¹æ®åå­—æœç´¢å¯¹åº”çš„å­¦ç”Ÿ</li>
<li>ç‚¹å‡»æœç´¢å‡ºæ¥çš„å­¦ç”Ÿä¿¡æ¯ï¼Œèƒ½æŸ¥é˜…å¯¹åº”çš„æˆç»©</li>
</ol>
<p>å°çº¢é’ˆå¯¹è¿™ä¸¤ä¸ªéœ€æ±‚ï¼Œæä¾›äº†ä¸¤ä¸ªAPIåˆ†åˆ«ç”¨äºä¸Šè¿°åœºæ™¯ï¼š</p>
<ul>
<li>æ ¹æ®åå­—æœç´¢å¯¹åº”çš„å­¦ç”Ÿåˆ—è¡¨</li>
</ul>
<pre><code class="java">@RestController
@RequestMapping(&quot;/students&quot;)
public class StudentController {

    private StudentInfoService studentInfoService;

    @Autowired
    public StudentController(StudentInfoService studentInfoService) {
        this.studentInfoService = studentInfoService;
    }

    @GetMapping
    public List&lt;Student&gt; getStudentByStudentNo(@RequestParam String name) {
        return studentInfoService.searchStudents(name);
    }

}
</code></pre>
<ul>
<li>æŸ¥é˜…æˆç»©ï¼ˆé€šè¿‡å­¦ç”Ÿæ ‡è¯†æŸ¥è¯¢å³å¯ï¼‰</li>
</ul>
<pre><code class="java">
@RestController
@RequestMapping(&quot;/scores&quot;)
public class ScoreController {

    private ScoreService scoreService;

    @Autowired
    public ScoreController(StudentInfoService studentInfoService, ScoreService scoreService) {
        this.scoreService = scoreService;
    }

    @GetMapping
    public Score getScoreByStudentNo(@RequestParam String studentId) {
        return Score.builder().studentId(studentId).score(scoreService.getScore(studentId)).build();
    }
}
</code></pre>
<p>ç”±äºå­¦ç”Ÿçš„åŸºç¡€ä¿¡æ¯å’Œå­¦ç”Ÿçš„æˆç»©ä¿¡æ¯éƒ½æ˜¯å¤–éƒ¨ç³»ç»Ÿï¼Œå› æ­¤åœ¨æµ‹è¯•æ—¶ï¼Œå°çº¢ä½¿ç”¨äº†Mockå¤§æ³•<code>@MockBean</code>ï¼ˆmockitoï¼‰ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li>å­¦ç”Ÿæœç´¢æµ‹è¯•</li>
</ul>
<pre><code class="java">public class StudentControllerTest extends APITest {

    @Test
    public void should_search_students() {
        Student student = new Student(&quot;id&quot;, &quot;studentNo&quot;, &quot;zhangsan&quot;);
        when(studentInfoService.searchStudents(student.getName())).thenReturn(
                Lists.newArrayList(student));

        given().param(&quot;name&quot;, student.getName()).get(&quot;/students&quot;).then().statusCode(200).body(
                &quot;[0].studentNo&quot;, is(student.getStudentNo())).body(&quot;[0].id&quot;, is(student.getId()));
    }
}
</code></pre>
<ul>
<li>æˆç»©æŸ¥é˜…æµ‹è¯•</li>
</ul>
<pre><code class="java">public class ScoreControllerTest extends APITest {

    @MockBean
    private ScoreService scoreService;

    @Test
    public void should_get_score_by_student_id() {
        Student student = new Student(&quot;id&quot;, &quot;studentNo&quot;, &quot;zhangsan&quot;);

        when(scoreService.getScore(student.getId())).thenReturn(99.9f);

        given().param(&quot;studentId&quot;, student.getId()).get(&quot;/scores&quot;).then().statusCode(200).body(
                &quot;score&quot;, equalTo(99.9f));
    }
}
</code></pre>
<p>å—¯ï¼Ÿè¿™é‡Œæ€ä¹ˆæœ‰ä¸ª<code>IntegrationTest</code>ã€‚è¿™é‡Œå°çº¢æŠ½è±¡äº†ä¸ªåŸºç¡€çš„APIæµ‹è¯•ï¼Œä¸»è¦å¤„ç†ä¸€äº›RestAssuredçš„é…ç½®ã€‚ï¼ˆRestAssuredåˆæ˜¯ä»€ä¹ˆé¬¼â€“ä¸€ä¸ªæµ‹è¯•Rest APIçš„æ¡†æ¶ï¼‰ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<pre><code class="java">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestExecutionListeners({DirtiesContextTestExecutionListener.class,
        MockitoTestExecutionListener.class, DependencyInjectionTestExecutionListener.class})
@ActiveProfiles(&quot;test&quot;)
public abstract class APITest extends AbstractTestNGSpringContextTests {

    @LocalServerPort
    private int port;

    private static void initRestAssured(int port) {
        RestAssured.basePath = &quot;/api&quot;;
        RestAssured.port = port;
        RestAssured.requestSpecification = new RequestSpecBuilder().setContentType(
                &quot;application/json&quot;).build();
    }

    @BeforeMethod
    public void setUp() {
        initRestAssured(port);
    }

}
</code></pre>
<p>å°±è¿™äº›äº†ï¼Œå°çº¢å•ç‹¬è·‘<code>StudentControllerTest</code>å’Œ<code>ScoreControllerTest</code>éƒ½æ²¡æœ‰é—®é¢˜ã€‚å¯ä½¿ç”¨æ„å»ºå·¥å…·ä¸€èµ·è·‘æµ‹è¯•æ—¶ï¼Œ<code>StudentControllerTest</code>æµ‹è¯•å°±ä¼šæŒ‚æ‰ã€‚å¹¶è¢«ä¸¢è¿‡æ¥ä¸€å¨å¦‚ä¸‹çš„é”™è¯¯ä¿¡æ¯ï¼š</p>
<pre><code class="plain">java.lang.AssertionError: 1 expectation failed.
JSON path [0].studentNo doesn&#39;t match.
Expected: is &quot;studentNo&quot;
  Actual: null
</code></pre>
<p>çœŸæ˜¯ç™¾æ€ä¸å¾—å…¶è§£ï¼Œæ˜æ˜mockäº†<code>StudentInfoService</code>ï¼Œæ€ä¹ˆå°±åƒæ²¡æœ‰mockä¸€æ ·ç›´æ¥è¿”å›<code>null</code>äº†å‘¢ï¼Ÿéš¾é“mockå¤±æ•ˆäº†ï¼Ÿè¿˜æ˜¯é€‰æ‹©æ€§çš„å¤±æ•ˆå—ï¼Ÿ</p>
<h3 id="2-å±±é‡æ°´å¤ç–‘æ— è·¯"><a href="#2-å±±é‡æ°´å¤ç–‘æ— è·¯" class="headerlink" title="2. å±±é‡æ°´å¤ç–‘æ— è·¯"></a>2. å±±é‡æ°´å¤ç–‘æ— è·¯</h3><p>mockæ²¡æœ‰ç”Ÿæ•ˆï¼Œè«éæ˜¯mockçš„å¯¹è±¡å’Œä½¿ç”¨çš„å¯¹è±¡æ˜¯ä¸åŒçš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨<code>StudentControllerTest</code>ä¸­çš„mockBean studentInfoServiceå’Œspringä¸Šä¸‹æ–‡ä¸­çš„studentInfoServiceä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Ÿ</p>
<p>ä¸ºäº†éªŒè¯è¿™ç‚¹ï¼Œå°çº¢åœ¨<code>ScoreController</code>ä¹Ÿæ³¨å…¥äº†<code>StudentInfoService</code>ã€‚ç„¶åè°ƒè¯•å‘ç°ï¼Œåœ¨è¿è¡Œ<code>ScoreControllerTest</code>æµ‹è¯•æ—¶ï¼Œä½¿ç”¨çš„å¯¹è±¡ä¸ºï¼š</p>
<p><img src="/images/mockbean-not-working-1.png" alt="1"></p>
<p>è¿™ä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå› ä¸ºè¿™æ—¶å¹¶æ²¡æœ‰å¯¹<code>StudentInfoService</code>è¿›è¡Œmockï¼Œå½“ç„¶å°±åªæœ‰<code>ScoreService</code>è¢«mockäº†ã€‚</p>
<p>åœ¨<code>StudentControllerTest</code>è¿è¡Œæ—¶ï¼Œåœ¨æµ‹è¯•æ–¹æ³•å¤„studentInfoServiceå¯¹è±¡ä¸ºï¼š</p>
<p><img src="/images/mockbean-not-working-2.png" alt="2"></p>
<p>è€Œåœ¨æ‰§è¡Œåˆ°è¢«æµ‹è¯•çš„<code>StudentController</code>æ—¶ï¼Œæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="/images/mockbean-not-working-3.png" alt="3"></p>
<p>æ˜çœ¼äººä¸€ä¸‹å°±çœ‹å‡ºæ¥äº†ï¼Œåœ¨<code>StudentControllerTest</code>æ‰§è¡Œæ—¶ï¼Œæµ‹è¯•é‡Œmockäº†<code>StudentInfoService</code>ï¼Œä½†springä¸Šä¸‹æ–‡é‡Œæ²¡æœ‰mockã€‚å†ä¸€ç»†çœ‹ï¼Œå±…ç„¶å’Œ<code>ScoreControllerTest</code>æ‰§è¡Œæ—¶ï¼Œspringä¸Šä¸‹æ–‡ä¸­çš„<code>StudentInfoService</code>æ˜¯ä¸€ä¸ªå®ä¾‹ã€‚</p>
<p>éš¾é“å¤šä¸ªæµ‹è¯•å…±ç”¨çš„ä¸€ä¸ªæµ‹è¯•ä¸Šä¸‹æ–‡å—ï¼Ÿ</p>
<p>ç»è¿‡ä¸€ç•ªæ’æŸ¥ï¼Œæœä¸å…¶ç„¶ï¼Œç”±äºå¯åŠ¨springä¸Šä¸‹æ–‡ç›¸å¯¹æ¯”è¾ƒè€—æ—¶ï¼Œspringæµ‹è¯•æœ‰ç¼“å­˜ä¸Šä¸‹æ–‡çš„é€»è¾‘ã€‚åœ¨<code>DefaultCacheAwareContextLoaderDelegate</code>ä¸­ï¼Œæœ‰å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼š</p>
<pre><code class="java">@Override
public ApplicationContext loadContext(MergedContextConfiguration mergedContextConfiguration) {
    synchronized (this.contextCache) {
        ApplicationContext context = this.contextCache.get(mergedContextConfiguration);
        if (context == null) {
            try {
                //load spring context
        }
        else {
            if (logger.isDebugEnabled()) {
                logger.debug(String.format(&quot;Retrieved ApplicationContext from cache with key [%s]&quot;,
                        mergedContextConfiguration));
            }
        }

        this.contextCache.logStatistics();

        return context;
    }
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ä¼šå…ˆä»ç¼“å­˜é‡Œè·å–ï¼Œå¦‚æœç¼“å­˜æ²¡æœ‰å†è¿›è¡ŒåŠ è½½ã€‚å¦å¤–ï¼Œå°çº¢æ³¨æ„åˆ°ï¼Œè·å–ç¼“å­˜çš„keyä¸º<code>MergedContextConfiguration</code>ç±»å‹çš„å¯¹è±¡ã€‚<code>MergedContextConfiguration</code>ä¸ºspringä¸Šä¸‹æ–‡çš„é…ç½®ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ä¸Šè¿°ä¸¤ä¸ªæµ‹è¯•é‡Œï¼Œä»–ä»¬çš„<code>mergedContextConfiguration</code>æ˜¯ä¸€æ ·çš„å—ï¼Ÿ</p>
<p><code>contextCache</code>å†…éƒ¨å…¶å®æ˜¯ä¸€ä¸ª<code>Map</code>ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œmapé‡Œçš„keyæ˜¯å¦æ˜¯ä¸€è‡´çš„ï¼Œè¦çœ‹<code>hashcode</code>å’Œ<code>equals</code>ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="java">@Override
public boolean equals(@Nullable Object other) {
    if (this == other) {
        return true;
    }
    ...
    if (!this.contextCustomizers.equals(otherConfig.contextCustomizers)) {
        return false;
    }
    ...
    return true;
}

@Override
public int hashCode() {
    int result = Arrays.hashCode(this.locations);
    ...
    result = 31 * result + this.contextCustomizers.hashCode();
    ...
    return result;
}
</code></pre>
<p>è¿™é‡Œä¸ºäº†èŠ‚çº¦ç¯‡å¹…ï¼Œåªåˆ—å‡ºè¿™æ¬¡éœ€è¦å…³å¿ƒçš„éƒ¨åˆ†ã€‚å°çº¢çœ‹åˆ°è¦çœ‹<code>mergedContextConfiguration</code>æ˜¯å¦ä¸€è‡´ï¼Œå…¶ä¸­ä¸€ä¸ªå› ç´ æ˜¯çœ‹<code>contextCustomizers</code>æ˜¯å¦ä¸€è‡´ã€‚åœ¨ä½¿ç”¨äº†<code>@MockBean</code>çš„åœºæ™¯ï¼Œä¼šåŠ è½½ä¸€ä¸ªç±»å‹ä¸º<code>MockitoContextCustomizerFactory</code>çš„contextCustomizerã€‚<code>MockitoContextCustomizerFactory</code>ä¼šè§£æä½¿ç”¨<code>@MockBean</code>æ³¨å…¥å­—æ®µç±»å‹ã€‚</p>
<p>é‚£ä¹ˆï¼Œä¹Ÿå°±æ˜¯è¯´é’ˆå¯¹ä¸Šé¢çš„ä¸¤ä¸ªæµ‹è¯•ï¼Œå› ä¸ºä»–ä»¬çš„<code>@MockBean</code>ä½¿ç”¨çš„å­—æ®µç±»å‹ä¸ä¸€è‡´ï¼Œåº”è¯¥ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„springä¸Šä¸‹æ–‡æ‰å¯¹ã€‚äº‹å®ä¹Ÿç¡®å®æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="/images/mockbean-not-working-4.png" alt="4"></p>
<p>è¿™å°±å°´å°¬äº†ï¼Œæ˜æ˜æ˜¯ä¸¤ä¸ªä¸åŒçš„springä¸Šä¸‹æ–‡ï¼Œæ€ä¹ˆè¿è¡Œæ—¶ï¼Œä¸¤ä¸ªæµ‹è¯•ç”¨çš„æ˜¯åŒä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Ÿ</p>
<p>ä¼¼ä¹æ— è§£äº†â€¦</p>
<h3 id="3-æŸ³æš—èŠ±æ˜åˆä¸€æ‘"><a href="#3-æŸ³æš—èŠ±æ˜åˆä¸€æ‘" class="headerlink" title="3. æŸ³æš—èŠ±æ˜åˆä¸€æ‘"></a>3. æŸ³æš—èŠ±æ˜åˆä¸€æ‘</h3><p>å°çº¢æ³¨æ„åˆ°ï¼Œåœ¨ä¸¤ä¸ªæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬çš„<code>ApiTest</code>ä¸­çš„ç«¯å£<code>port</code>æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå±æ€§çš„æ³¨å…¥æ˜¯è·Ÿç€springä¸Šä¸‹æ–‡èµ°çš„ã€‚</p>
<p>æ—¢ç„¶ç°åœ¨çš„æµ‹è¯•æ€»æ˜¯ä¼šèµ°åˆ°åŒä¸€ä¸ªä¸Šä¸‹æ–‡é‡Œï¼Œé‚£èƒ½ä¸èƒ½ç›´æ¥æµ‹è¯•ç¬¬äºŒä¸ªä¸Šä¸‹æ–‡çš„é€»è¾‘å‘¢ï¼Ÿ</p>
<p>å°çº¢æƒ³åˆ°ä¸€ä¸ªåŠæ³•ï¼Œåœ¨<code>StudentControllerTest</code>æµ‹è¯•ä¸­çš„mocké€»è¾‘åï¼Œå¢åŠ ä¸€ä¸ªæ–­ç‚¹ã€‚å½“ç¨‹åºè¿è¡Œåˆ°è¿™ä¸ªæ–­ç‚¹åï¼Œæ‹¿åˆ°å¯¹åº”çš„ç«¯å£<code>port</code>ï¼Œç„¶ååœ¨æµè§ˆå™¨ç›´æ¥è®¿é—®å¯¹åº”éœ€è¦æµ‹è¯•çš„api:<code>http://localhost:port/api/students</code>ã€‚</p>
<p>æˆå‰§çš„ä¸€å¹•å‡ºç°äº†ï¼Œæµè§ˆå™¨è®¿é—®åè¿”å›äº†æˆ‘ä»¬mockçš„studentåˆ—è¡¨ï¼Œä¸æ˜¯ç©ºäº†ã€‚è¿™å°±è¿‡åˆ†äº†ã€‚æ˜æ˜åœ¨<code>ApiTest</code>çš„<code>setup</code>ä¸­æŒ‡å®šäº†éœ€è¦è®¿é—®çš„ç«¯å£ï¼Œæ€ä¹ˆè¿˜æ˜¯è®¿é—®çš„æœ€å¼€å§‹çš„ç«¯å£ï¼Œéš¾é“ç«¯å£è®¾ç½®æ²¡ç”Ÿæ•ˆï¼Ÿå°çº¢ç»§ç»­å¯»æ‰¾çœŸç›¸ã€‚</p>
<p>ä¾æ¬¡è·Ÿè¸ªäº†ï¼ŒRestAssuredå‘èµ·è¯·æ±‚çš„æµç¨‹ï¼Œå‘ç°åœ¨<code>APITest</code>ä¸­æˆ‘ä»¬è®¾ç½®äº†è¯·æ±‚çš„content-typeï¼š</p>
<pre><code class="java"> RestAssured.requestSpecification = new RequestSpecBuilder().setContentType(
                &quot;application/json&quot;).build();
</code></pre>
<p>è€ŒRequestSpecBuilderçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="java">    public RequestSpecBuilder() {
        this.spec = (RequestSpecificationImpl) new RequestSpecificationImpl(baseURI, port, basePath, authentication, filters(),
                requestSpecification, urlEncodingEnabled, config, new LogRepository(), proxy).config(RestAssured.config());
    }
</code></pre>
<p>å…¶ä¸­ç¬¬å…­ä¸ªå…¥å‚ï¼Œä¸ºé»˜è®¤çš„è¯·æ±‚æè¿°ï¼ˆåŒ…å«è¯·æ±‚ç«¯å£ï¼‰ã€‚è¿™ä¸ªé»˜è®¤çš„è¯·æ±‚æè¿°æ¥æºäºå‰ä¸€ä¸ªæµ‹è¯•è®¾ç½®çš„<code>RestAssured.requestSpecification</code>ï¼Œä¹Ÿå³<code>StudentControllerTest</code>è¿è¡Œæ—¶ï¼Œåˆ™ä¸º<code>ScoreControllerTest</code>æµ‹è¯•è®¾ç½®çš„è¯·æ±‚æè¿°ã€‚<br>å°±ç®—é»˜è®¤å€¼ä½¿ç”¨å‰ä¸€ä¸ªä¹Ÿæ²¡å…³ç³»ï¼Œæ–°è®¾ç½®äº†<code>RestAssured.port</code>ï¼Œå°±åº”è¯¥ç”¨æ–°çš„ç«¯å£äº†ã€‚ç„¶è€Œé—®é¢˜å°±å‡ºåœ¨è¿™ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>RequestSpecificationImpl</code>çš„æ„é€ æ–¹æ³•ï¼š</p>
<pre><code class="java">public RequestSpecificationImpl(String baseURI, int requestPort, String basePath, AuthenticationScheme defaultAuthScheme, List&lt;Filter&gt; filters,
                                  RequestSpecification defaultSpec, boolean urlEncode, RestAssuredConfig restAssuredConfig, LogRepository logRepository,
                                  ProxySpecification proxySpecification) {
    ...
    port(requestPort)
    this.restAssuredConfig = restAssuredConfig
    if (defaultSpec != null) {
      spec(defaultSpec)
    }
    ...
  }
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ç¡®å®å…ˆè®¾ç½®äº†è¯·æ±‚çš„ç«¯å£ï¼Œä½†åé¢æ¥ç€å¤„ç†é»˜è®¤çš„è¯·æ±‚æè¿°ã€‚ç»§ç»­çœ‹ä¸‹æ˜¯å¦‚ä½•å¤„ç†çš„ï¼š</p>
<pre><code class="java">  RequestSpecification spec(RequestSpecification requestSpecificationToMerge) {
    SpecificationMerger.merge this, requestSpecificationToMerge
    return this
  }
</code></pre>
<p>å¥½ï¼Œç»§ç»­è·Ÿè¿›ï¼š</p>
<pre><code class="java">def static void merge(RequestSpecificationImpl thisOne, RequestSpecificationImpl with) {
    notNull thisOne, &quot;Specification to merge&quot;
    notNull with, &quot;Specification to merge with&quot;

    thisOne.port = with.port
    thisOne.baseUri = with.baseUri
    thisOne.basePath = with.basePath
    thisOne.requestParameters.putAll(with.requestParameters)
    thisOne.queryParameters.putAll(with.queryParams)
    thisOne.formParameters.putAll(with.formParams)
    thisOne.namedPathParameters.putAll(with.pathParams)
    thisOne.multiParts.addAll(with.multiParts)
    thisOne.authenticationScheme = with.authenticationScheme
    mergeSessionId(thisOne, with)
    thisOne.cookies(with.cookies)
    thisOne.requestBody = with.requestBody
    mergeFilters(thisOne, with)
    thisOne.urlEncodingEnabled = with.urlEncodingEnabled
    thisOne.proxySpecification = with.proxySpecification
    thisOne.method = with.method
    thisOne.unnamedPathParamsTuples = with.unnamedPathParamValues
    thisOne.path = with.path

    mergeConfig(thisOne, with)
    // It&#39;s important that headers are merged after the configs are merged since HeaderConfig affects that way headers are merged.
    thisOne.headers(with.requestHeaders)
  }
</code></pre>
<p>æ³¨æ„ï¼Œè¿™é‡Œçš„ç¬¬äºŒä¸ªå‚æ•°<code>with</code>å°±æ˜¯æˆ‘ä»¬çš„é»˜è®¤å€¼ã€‚çº³å°¼ï¼Œå±…ç„¶ç”¨é»˜è®¤å€¼è¦†ç›–äº†æ‰€æœ‰çš„å€¼ã€‚ä½ ä¸æ˜¯çœŸæ­£çš„é»˜è®¤å€¼ï¼Œä½ å°±æ˜¯å¤©ä½ å°±æ˜¯åœ°ï¼Œä½ æ‰æ˜¯æœ€å¤§å•Šï¼</p>
<p><strong>çœŸç›¸å¤§ç™½</strong>äº†ï¼Œè™½ç„¶åœ¨<code>StudentControllerTest</code>æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬è®¾ç½®äº†ç«¯å£ï¼Œä½†æ˜¯ç”±äºRestAssuredçš„åŸå› ï¼Œä¼šç»§ç»­ä½¿ç”¨å‰ä¸€ä¸ªæµ‹è¯•çš„ç«¯å£è®¾ç½®ã€‚æˆ‘ä»¬é”™æ€ªäº†mockï¼Œç½ªé­ç¥¸é¦–åœ¨å‘èµ·è¯·æ±‚çš„åœ°æ–¹ï¼šRestAssured.</p>
<p>æ‰¾åˆ°é—®é¢˜ï¼Œè§£å†³åŠæ³•å°±å¾ˆç®€å•äº†ï¼Œåœ¨æ¯æ¬¡è®¾ç½®ä¹‹å‰ï¼Œå°†ç›¸å…³é…ç½®é‡ç½®ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚å¦‚ä¸‹ï¼š</p>
<pre><code class="java"> private static void initRestAssured(int port) {
        RestAssured.reset();//ç”¨äºé‡ç½®restAssuredç›¸å…³é…ç½®
        RestAssured.basePath = &quot;/api&quot;;
        RestAssured.port = port;
        RestAssured.requestSpecification = new RequestSpecBuilder().setContentType(
                &quot;application/json&quot;).build();
    }
</code></pre>
<h3 id="4-è‹¥æœ‰æ‰€æ€"><a href="#4-è‹¥æœ‰æ‰€æ€" class="headerlink" title="4. è‹¥æœ‰æ‰€æ€"></a>4. è‹¥æœ‰æ‰€æ€</h3><p>å°çº¢çš„æµ‹è¯•ç»ˆäºå¯ä»¥ç»§ç»­æ„‰å¿«çš„è¿è¡Œäº†ï¼Œä½†å°çº¢æ€è™‘é‡é‡ã€‚ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°<code>@MockBean</code>ä¼šå¼•èµ·åŠ è½½å¤šæ¬¡springä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªåœ¨é¡¹ç›®è¶Šæ¥è¶Šå¤§çš„æƒ…å†µä¸‹ï¼ŒMockBeanæ³›æ»¥äº†ä¹‹åï¼Œæµ‹è¯•ä¼šå¦‚æ…¢å¦‚èœ—ç‰›ğŸŒã€‚åœ¨APIçº§åˆ«çš„æµ‹è¯•ï¼Œæˆ‘ä»¬ä¸»è¦æƒ³æŠŠä¸‰æ–¹ç³»ç»Ÿçš„ä¾èµ–ç»™mockæ‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å•ç‹¬åœ°å°†æ‰€æœ‰çš„ä¸‰æ–¹ä¾èµ–åšæˆæµ‹è¯•é…ç½®ã€‚ç„¶åæ‰€æœ‰çš„æµ‹è¯•ä½¿ç”¨åŒä¸€å¥—æµ‹è¯•é…ç½®ï¼Œä½¿ç”¨çš„åœ°æ–¹ç›´æ¥ä½¿ç”¨<code>@Autowired</code>æ³¨å…¥å³å¯ã€‚</p>
<p>æ¯”å¦‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šå¢åŠ ä¸€ä¸ªæµ‹è¯•é…ç½®ï¼š</p>
<pre><code class="java">@Configuration
public class TestConfiguration {

    @Bean
    public StudentInfoService mockStudentInfoService() {
        return mock(StudentInfoService.class);
    }

    @Bean
    public ScoreService mockScoreService() {
        return mock(ScoreService.class);
    }
}
</code></pre>
<p>åç»­å¦‚æœè¿˜æœ‰å…¶ä»–çš„éœ€è¦mock springå†…éƒ¨ç»„ä»¶çš„ï¼Œä¹Ÿéƒ½ç»Ÿä¸€åŠ å…¥åˆ°æµ‹è¯•é…ç½®é‡Œã€‚è¿™æ ·å°±èƒ½åªåŠ è½½ä¸€ä¸ªspringä¸Šä¸‹æ–‡ã€‚</p>
<p>é™¤äº†ä¸Šè¿°çš„æµ‹è¯•é…ç½®ï¼Œè¦è®©æ•´ä½“æµ‹è¯•èƒ½å¤Ÿè¿è¡Œï¼Œè¿˜è¦å°†çœŸå®è°ƒç”¨å¤–éƒ¨çš„ç»„ä»¶æ ‡è¯†åœ¨æµ‹è¯•ä¸æ‰“å¼€ï¼Œè¿™æ ·æ‰èƒ½å°†æµ‹è¯•é…ç½®ä¸­çš„mockå¯¹è±¡â€æ›¿æ¢â€çœŸå®çš„ä¸‰æ–¹è°ƒç”¨ç»„ä»¶ã€‚åªéœ€åœ¨è¯¥ç±»ä¸‰æ–¹ç»„ä»¶ä¸Šå¢åŠ ä¸€ä¸ªæ³¨è§£ï¼š<code>@Profile(&quot;!test&quot;)</code>å³å¯ã€‚</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-07-28</span><i class="fa fa-tag"></i><a href="/tags/java/" title="java" class="tag">java </a><a href="/tags/spring/" title="spring" class="tag">spring </a></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://gavincook.me/mockbean-not-working/,å®ˆæœ›å†°é›¨,MockBean&quot;ç½¢å·¥äº†&quot;,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/spring-transaction-jpa/" title="ä½ çš„äº‹åŠ¡ç®¡ç†å™¨ç”¨å¯¹äº†å—" class="btn">ä¸Šä¸€ç¯‡</a></li><li class="next pagbuttons"><a role="navigation" href="/how-schedule-work-in-java/" title="Javaä¸­çš„å®šæ—¶ä»»åŠ¡ï¼ˆäºŒï¼‰ -- å·¥ä½œåŸç†" class="btn">ä¸‹ä¸€ç¯‡</a></li></ul></div><div id="container"></div><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
  id: 'mockbean-not-working/',
  owner: 'gavincook',
  repo: 'blog-comment',
  oauth: {
    client_id: 'c4abd5f7111d34bf1433',
    client_secret: 'd5200b8002ac7f63acc69ebb119d9262e9967c3e',
  },
});
gitment.render('container');


</script></div></div></div></div><script src="/js/jquery.js"></script><script>$(function(){
  $("pre").addClass("line-numbers");
  $("pre code").each(function(index, e){
      var oldCss = $(this).attr("class");
      if(oldCss){
        $(this).removeClass(oldCss).addClass("language-" + oldCss);
      }else{
        $(this).addClass("language-javascript");
      }
  });
});</script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/prism.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>